{% extends 'base.html' %}
{% block title %}Expenses{% endblock %}

{% block content %}
<div class="expenses-page-container fade-in">
  
  <div class="container mt-4 mb-5">
    <!-- SUMMARY CARDS -->
    <div class="row g-4 justify-content-center">
      <!-- Income Card -->
      <div class="col-lg-4 col-md-6">
        <div class="summary-card card-income shadow-lg">
          <div class="card-body p-4 position-relative">
            <div class="icon-bg"><i class="fas fa-wallet"></i></div>
            <h6 class="text-uppercase text-white-50 fw-bold ls-1">Income (Collected)</h6>
            <h2 class="text-white mb-0 fw-bold">Rs {{ total_income_current }}</h2>
            <p class="text-white-50 small mt-2 mb-0">
              {% if selected_filter_month == 'all' %}
                Total for {{ current_year }}
              {% else %}
                {{ month_names[current_month] }} {{ current_year }}
              {% endif %}
            </p>
          </div>
        </div>
      </div>

      <!-- Expense Card -->
      <div class="col-lg-4 col-md-6">
        <div class="summary-card card-expense shadow-lg">
          <div class="card-body p-4 position-relative">
            <div class="icon-bg"><i class="fas fa-receipt"></i></div>
            <h6 class="text-uppercase text-white-50 fw-bold ls-1">Expenses (Paid)</h6>
            <h2 class="text-white mb-0 fw-bold">Rs {{ total_expenses_current }}</h2>
            <p class="text-white-50 small mt-2 mb-0">
              {% if selected_filter_month == 'all' %}
                Deducted from {{ current_year }}
              {% else %}
                Deducted from {{ month_names[current_month] }}
              {% endif %}
            </p>
          </div>
        </div>
      </div>

      <!-- Balance Card -->
      <div class="col-lg-4 col-md-6">
        <div class="summary-card card-balance shadow-lg">
          <div class="card-body p-4 position-relative">
            <div class="icon-bg"><i class="fas fa-coins"></i></div>
            <h6 class="text-uppercase text-white-50 fw-bold ls-1">Net Balance</h6>
            <h2 class="text-white mb-0 fw-bold">Rs {{ remaining_balance_current }}</h2>
            <p class="text-white-50 small mt-2 mb-0">Cash in Hand</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container mb-5">
    <!-- CONTROL PANEL CARD -->
    <div class="card border-0 shadow-lg rounded-4 overflow-hidden" style="background: rgba(255,255,255,0.95);">
      
      <div class="card-header bg-white border-0 p-3 d-flex justify-content-between align-items-center">
        <h5 class="fw-bold mb-0 text-dark"><i class="fas fa-sliders-h me-2 text-primary"></i> Manage Expenses</h5>
        <button class="btn btn-primary rounded-pill px-4 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#controlsCollapse">
          <i class="fas fa-chevron-down me-2"></i> Toggle Menu
        </button>
      </div>

      <div class="collapse show" id="controlsCollapse">
        <div class="card-body p-4">
          <!-- TABS -->
          <ul class="nav nav-pills mb-4 nav-fill gap-2 p-1 bg-light rounded-pill" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active rounded-pill fw-bold" id="pills-add-tab" data-bs-toggle="pill" data-bs-target="#pills-add" type="button">
                <i class="fas fa-plus-circle me-2"></i> Add New Expense
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link rounded-pill fw-bold" id="pills-filter-tab" data-bs-toggle="pill" data-bs-target="#pills-filter" type="button">
                <i class="fas fa-filter me-2"></i> Filter List
              </button>
            </li>
          </ul>

          <div class="tab-content" id="pills-tabContent">
            <!-- ADD EXPENSE FORM -->
            <div class="tab-pane fade show active" id="pills-add">
              <form method="POST" action="{{ url_for('expenses') }}" class="needs-validation" novalidate>
                {{ form.hidden_tag() }}
                <div class="row g-3">
                  <div class="col-md-3">
                    <div class="form-floating">
                      {{ form.item_name(class="form-control fw-bold", placeholder="Item", required=True) }}
                      <label>Item Name</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      {{ form.price(class="form-control fw-bold", placeholder="Price", required=True) }}
                      <label>Price (Rs)</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      <select class="form-select fw-bold" name="status" id="statusSelect">
                        <option value="Paid">Paid</option>
                        <option value="Unpaid">Unpaid</option>
                      </select>
                      <label>Status</label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-floating">
                      {{ form.date(class="form-control fw-bold", type="date", required=True) }}
                      <label>Date</label>
                    </div>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success btn-lg w-100 fw-bold shadow-sm">
                      <i class="fas fa-check-circle me-2"></i> Save Expense
                    </button>
                  </div>
                </div>
              </form>
            </div>

            <!-- FILTER FORM -->
            <div class="tab-pane fade" id="pills-filter">
              <form method="GET" action="{{ url_for('expenses') }}" class="row g-3 align-items-center">
                <div class="col-md-4">
                  <label class="small text-muted fw-bold mb-1">Year</label>
                  <select name="year" class="form-select form-select-lg fw-bold">
                    {% for y in range(current_year - 2, current_year + 3) %}
                      <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="small text-muted fw-bold mb-1">Month</label>
                  <select name="month" class="form-select form-select-lg fw-bold">
                    <option value="all" {% if selected_filter_month == 'all' %}selected{% endif %}>Months</option>
                    {% for m in range(1, 13) %}
                      <option value="{{ m }}" {% if m|string == selected_filter_month|string %}selected{% endif %}>{{ month_names[m] }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="small text-muted fw-bold mb-1">Status</label>
                  <select name="status_filter" class="form-select form-select-lg fw-bold">
                    <option value="all" {% if selected_filter_status == 'all' %}selected{% endif %}>All Statuses</option>
                    <option value="Paid" {% if selected_filter_status == 'Paid' %}selected{% endif %}>Paid Only</option>
                    <option value="Unpaid" {% if selected_filter_status == 'Unpaid' %}selected{% endif %}>Unpaid Only</option>
                  </select>
                </div>
                <div class="col-12 mt-3">
                  <button type="submit" class="btn btn-dark btn-lg w-100 fw-bold">
                    <i class="fas fa-search me-2"></i> Apply Filters
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EXPENSE LIST -->
  <div class="container mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="text-white fw-bold m-0"><i class="fas fa-list-ul me-2"></i> Expense List</h4>
      {% if expenses_current %}
        <span class="badge bg-light text-dark rounded-pill px-3 py-2">Total Items: {{ expenses_current|length }}</span>
      {% endif %}
    </div>
    
    {% if expenses_current %}
    <div class="row g-4">
      {% for expense in expenses_current %}
      <div class="col-lg-4 col-md-6">
        <div class="card h-100 border-0 shadow-lg rounded-4 expense-card-hover">
          <div class="card-header bg-white border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
            <span class="badge bg-light text-secondary border px-3 py-2 rounded-pill">
              <i class="far fa-calendar-alt me-1"></i> {{ expense.date.strftime('%d %b, %Y') }}
            </span>
            {% if expense.status == 'Paid' %}
              <span class="badge bg-success-subtle text-success border border-success px-3 py-2 rounded-pill fw-bold">Paid</span>
            {% else %}
              <span class="badge bg-warning-subtle text-warning border border-warning px-3 py-2 rounded-pill fw-bold">Unpaid</span>
            {% endif %}
          </div>
          
          <div class="card-body px-4 py-3">
            <h5 class="card-title fw-bold text-dark mb-1" style="font-size: 1.25rem;">{{ expense.item_name }}</h5>
            <h2 class="display-6 fw-bold text-primary mt-2">Rs {{ expense.price }}</h2>
          </div>

          <div class="card-footer bg-white border-0 px-4 pb-4 pt-0">
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-primary flex-grow-1 py-2 fw-bold rounded-3" 
                      data-bs-toggle="modal" data-bs-target="#editModal{{ expense.id }}">
                <i class="fas fa-edit me-1"></i> Edit
              </button>
              <button type="button" class="btn btn-outline-danger flex-grow-1 py-2 fw-bold rounded-3" 
                      data-bs-toggle="modal" data-bs-target="#deleteModal{{ expense.id }}">
                <i class="fas fa-trash-alt me-1"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5 rounded-4" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
      <div class="text-white opacity-50 mb-3"><i class="fas fa-box-open fa-4x"></i></div>
      <h3 class="text-white fw-bold">No Expenses Found</h3>
      <p class="text-white-50 fs-5">
        Filtering: 
        <strong>{{ selected_filter_status }}</strong> in 
        <strong>
          {% if selected_filter_month == 'all' %}
            {{ current_year }}
          {% else %}
            {{ month_names[current_month] }}
          {% endif %}
        </strong>
      </p>
    </div>
    {% endif %}
  </div>

  <!-- MODALS LOOP -->
  {% for expense in expenses_current %}
  <!-- Edit Modal -->
  <div class="modal fade" id="editModal{{ expense.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header bg-primary text-white border-0">
          <h5 class="modal-title fw-bold">Edit Expense</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form action="{{ url_for('edit_expense', expense_id=expense.id) }}" method="POST">
          <div class="modal-body p-4">
            <div class="mb-3">
              <label class="fw-bold mb-1">Item Name</label>
              <input type="text" class="form-control form-control-lg" name="item_name" value="{{ expense.item_name }}" required>
            </div>
            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="fw-bold mb-1">Price</label>
                <input type="number" step="0.01" class="form-control form-control-lg" name="price" value="{{ expense.price }}" required>
              </div>
              <div class="col-6">
                <label class="fw-bold mb-1">Status</label>
                <select class="form-select form-select-lg" name="status">
                  <option value="Paid" {% if expense.status == 'Paid' %}selected{% endif %}>Paid</option>
                  <option value="Unpaid" {% if expense.status == 'Unpaid' %}selected{% endif %}>Unpaid</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="fw-bold mb-1">Date</label>
              <input type="date" class="form-control form-control-lg" name="date" value="{{ expense.date.strftime('%Y-%m-%d') }}" required>
            </div>
          </div>
          <div class="modal-footer bg-light border-0 rounded-bottom-4">
            <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary fw-bold px-4">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal fade" id="deleteModal{{ expense.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-body text-center p-4">
          <div class="text-danger mb-3"><i class="fas fa-trash-alt fa-3x"></i></div>
          <h5 class="fw-bold">Delete Item?</h5>
          <p class="text-muted small">Are you sure you want to delete <strong>{{ expense.item_name }}</strong>?</p>
          <div class="d-grid gap-2 mt-4">
            <form action="{{ url_for('delete_expense', expense_id=expense.id) }}" method="POST">
              <button type="submit" class="btn btn-danger w-100 fw-bold">Yes, Delete</button>
            </form>
            <button type="button" class="btn btn-light w-100 fw-bold" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

</div>

<style>
  /* Page Animation */
  .fade-in { animation: fadeIn 0.6s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

  /* Summary Cards */
  .summary-card {
    border-radius: 20px;
    overflow: hidden;
    color: white;
    height: 100%;
    transition: transform 0.3s ease;
  }
  .summary-card:hover { transform: translateY(-5px); }
  
  .card-income { background: linear-gradient(135deg, #10b981, #059669); }
  .card-expense { background: linear-gradient(135deg, #ef4444, #b91c1c); }
  .card-balance { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }

  .icon-bg {
    position: absolute; right: -10px; top: -10px;
    font-size: 6rem; opacity: 0.15; transform: rotate(15deg);
  }

  /* Expense Grid Cards */
  .expense-card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
  .expense-card-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.15) !important;
  }

  /* Controls */
  .nav-pills .nav-link.active { background-color: #3b82f6; color: white; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.4); }
  .nav-pills .nav-link { color: #64748b; transition: all 0.3s; }
  .nav-pills .nav-link:hover { background-color: #e2e8f0; }

  /* Buttons */
  .btn-lg { border-radius: 12px; font-size: 1rem; padding: 12px; }
  .btn-outline-primary:hover, .btn-outline-danger:hover { transform: translateY(-2px); }
</style>

<script>
  // Bootstrap Form Validation
  (function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms).forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })
  })()
</script>
{% endblock %}